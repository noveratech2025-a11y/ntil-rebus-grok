name: NTIL REBUS-GROK CI/CD

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  id-token: write  # Required for OIDC signing

env:
  REGISTRY: ghcr.io
  REPO_OWNER: noveratech2025-a11y
  REPO_NAME: ntil-rebus-grok

jobs:

  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.vars.outputs.sha }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract short SHA
        id: vars
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build backend image
        run: |
          docker build -t $REGISTRY/$REPO_OWNER/$REPO_NAME-backend:latest \
                       -t $REGISTRY/$REPO_OWNER/$REPO_NAME-backend:${{ steps.vars.outputs.sha }} \
                       backend/

      - name: Build frontend image
        run: |
          docker build -t $REGISTRY/$REPO_OWNER/$REPO_NAME-frontend:latest \
                       -t $REGISTRY/$REPO_OWNER/$REPO_NAME-frontend:${{ steps.vars.outputs.sha }} \
                       frontend/

      - name: Push images
        run: |
          docker push $REGISTRY/$REPO_OWNER/$REPO_NAME-backend:latest
          docker push $REGISTRY/$REPO_OWNER/$REPO_NAME-backend:${{ steps.vars.outputs.sha }}
          docker push $REGISTRY/$REPO_OWNER/$REPO_NAME-frontend:latest
          docker push $REGISTRY/$REPO_OWNER/$REPO_NAME-frontend:${{ steps.vars.outputs.sha }}

  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: 'v2.2.0'

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Generate SBOM (Backend)
        run: |
          syft $REGISTRY/$REPO_OWNER/$REPO_NAME-backend:${{ needs.build-and-push.outputs.sha }} \
            -o cyclonedx-json > sbom-backend.json

      - name: Generate SBOM (Frontend)
        run: |
          syft $REGISTRY/$REPO_OWNER/$REPO_NAME-frontend:${{ needs.build-and-push.outputs.sha }} \
            -o cyclonedx-json > sbom-frontend.json

      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: sbom-reports
          path: sbom-*.json

      - name: Sign backend image (Keyless)
        run: |
          cosign sign --yes $REGISTRY/$REPO_OWNER/$REPO_NAME-backend:${{ needs.build-and-push.outputs.sha }}
        env:
          COSIGN_EXPERIMENTAL: 1

      - name: Sign frontend image (Keyless)
        run: |
          cosign sign --yes $REGISTRY/$REPO_OWNER/$REPO_NAME-frontend:${{ needs.build-and-push.outputs.sha }}
        env:
          COSIGN_EXPERIMENTAL: 1

      - name: Verify signatures
        run: |
          cosign verify $REGISTRY/$REPO_OWNER/$REPO_NAME-backend:${{ needs.build-and-push.outputs.sha }} --certificate-identity-regexp="https://github.com/noveratech2025-a11y" || true
          cosign verify $REGISTRY/$REPO_OWNER/$REPO_NAME-frontend:${{ needs.build-and-push.outputs.sha }} --certificate-identity-regexp="https://github.com/noveratech2025-a11y" || true

  staging-deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to staging (compose)
        run: |
          docker compose -f deploy/docker-compose.yml pull
          docker compose -f deploy/docker-compose.yml up -d

  production-deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kube access
        run: mkdir -p $HOME/.kube && echo "${{ secrets.KUBECONFIG_FILE }}" > $HOME/.kube/config

      - name: Update images and rollout
        run: |
          kubectl set image deployment/rebus-backend \
            rebus-backend=$REGISTRY/$REPO_OWNER/$REPO_NAME-backend:${{ needs.build-and-push.outputs.sha }} -n rebus
          kubectl set image deployment/rebus-frontend \
            rebus-frontend=$REGISTRY/$REPO_OWNER/$REPO_NAME-frontend:${{ needs.build-and-push.outputs.sha }} -n rebus

          kubectl rollout status deployment/rebus-backend -n rebus --timeout=5m
          kubectl rollout status deployment/rebus-frontend -n rebus --timeout=5m
